<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>IoT 2019/2020 Exam Assignment 2 Tutorial</title>
  </head>
  <body><span style="font-family: Verdana;"> </span>
    <h1><span style="font-family: Verdana;">Assignment 2<br>
      </span> </h1>
    <span style="font-family: Verdana;"> </span>
    <h2><span style="font-family: Verdana;">RIOT-OS Virtual Environmental
        Stations publishing values to AWS IoT using MQTT-SN and MQTT</span></h2>
    <span style="font-family: Verdana;"> </span>
    <hr><span style="font-family: Verdana;"> </span>
    <p><span style="font-family: Verdana;">This assignment is an extension of
        Assignment 1, where the same dashboard and backend components are used
        to collect and display data from a set of virtual environmental stations
        that, in this case, are built over <i>RIOT-OS</i> and transmit using
        the <i>MQTT-SN</i> protocol.</span></p>
    <span style="font-family: Verdana;"> </span>
    <p><span style="font-family: Verdana;">The architecture implemented in this
        project can be represented as follows:</span></p>
    <span style="font-family: Verdana;"> </span>
    <div style="text-align: center;"><span style="font-family: Verdana;"><img src="web_images/assignment_2_architecture.PNG"

          alt="" title="architecture"></span></div>
    <span style="font-family: Verdana;"> </span>
    <div style="text-align: center;"><span style="font-family: Verdana;"><br>
      </span> </div>
    <span style="font-family: Verdana;"> </span>
    <div style="text-align: justify;"><span style="font-family: Verdana;">More
        in detail, a set of <i>virtual environmental stations</i>, implemented
        as RIOT-OS applications and run locally, generate random values for <i>temperature<em>,
            humidity, wind direction, wind intensity </em></i>and <i>rain
          height <em></em></i>and<i><em></em> </i>publishes them to a local
        MQTT-SN broker (in the example this broker is Mosquitto RSMB) using
        MQTT-SN. A MQTT-SN to MQTT bridge, implemented in Python, subscribes
        using MQTT to the MQTT-SN broker and forwards the messages produced by
        the environmental stations to AWS IoT. The messages are then forwarded
        to the <i>dashboard backend</i>, implemented in Python, which
        subscribes to the topic on which the bridge publishes the values
        generated by the stations. Upon receiving the messages, which are in
        JSON format, the backend stores them to a text file, which is then used
        by the web server to populate the dashboard.</span></div>
    <span style="font-family: Verdana;"> </span>
    <div style="text-align: justify;"><span style="font-family: Verdana;"><br>
      </span> </div>
    <span style="font-family: Verdana;"> </span>
    <div style="text-align: justify;"><span style="font-family: Verdana;">The
        dashboard and its backend are the same used in the <a href="assignment1.html">Assignment
          1 project</a>, and as a prerequisite we need the dashboard and the
        backend to be running, as well as the AWS configuration to be completed.
        For information on these aspects please refer to the Assignment 1
        project page. <br>
      </span> </div>
    <span style="font-family: Verdana;"> </span>
    <div style="text-align: justify;">
      <h2><span style="font-family: Verdana;">Running the system</span></h2>
      <p><span style="font-family: Verdana;">In this tutorial we concentrate on
          running the RIOT-OS nodes and the MQTT-SN to MQTT bridge, supposing
          that the AWS configuration as described in the <a href="assignment1.html">Assignment
            1 project</a> page has been completed and the backend and web server
          for the dashboard are already running.</span></p>
      <h3><span style="font-family: Verdana;">Setting up and launching the
          Mosquitto RSMB MQTT-SN broker</span></h3>
      <p><span style="font-family: Verdana;">The first step towards running the
          system, is the preparation of the MQTT-SN broker. To begin, the
          Mosquitto RSMB source code can be retrieved by cloning <a href="https://github.com/eclipse/mosquitto.rsmb.git">its
            repository</a> from GitHub. After cloning and building the source,
          you will be almost ready to launch the broker. As a further step, you
          need to copy the <code>rsmb.conf</code> file from the root of the
          project to the <code>&lt;brokerfolder&gt;/rsmb/src</code> path (<code>&lt;brokerfolder&gt;
            </code>is the folder where you cloned the broker repository and
          built it). Once this is done, the broker can be launched by <code></code>accessing
          the <code>&lt;brokerfolder&gt;/rsmb/src </code>folder and from
          there, assuming that RIOT-OS nodes and broker are run on a Linux
          system (in my case I used a VM), using the <code>./broker_mqtts
            rsmb.conf </code>command. <br>
        </span> </p>
      <div style="text-align: center;"><span style="font-family: Verdana;"><img

            src="web_images/mqttsn_broker_running.jpg" alt=""

            title="mqttsn_running"></span></div>
      <div style="text-align: justify;"><span style="font-family: Verdana;"><br>
        </span> </div>
      <div style="text-align: justify;"><span style="font-family: Verdana;">As
          it is possible to see from the above image, the provided configuration
          is such that the RSMB broker listens on port 1885 for MQTT-SN (used by
          the RIOT-OS stations) and 1886 for MQTT (used by the bridge).<br>
        </span> </div>
      <h3><span style="font-family: Verdana;">Building and running the RIOT-OS
          application</span></h3>
      <p><span style="font-family: Verdana;">In order to build and run on the
          local machine the RIOT-OS application, the first thing to be done is
          to clone the <a href="https://github.com/RIOT-OS/RIOT.git">RIOT-OS
            repository</a> to the RIOT-OS folder in the project root. It is
          important to respect the folder name if you don't want to edit the <code>riot_station_mqttsn/Makefile
            </code>to make the RIOTBASE variable point to the folder where you
          cloned the RIOT-OS repository.</span></p>
      <h4><span style="font-family: Verdana;">Setting up the local network for
          RIOT-OS communication</span></h4>
      <p><span style="font-family: Verdana;">In order to allow the communication
          between the RIOT-OS stations and the bridge running on the same
          machine, we need to set up the <em>tap </em>interfaces for the
          number of stations we'll be running and the bridge connecting all the
          interfaces. This can be done using the <em>tapsetup </em>utility
          bundled with the RIOT-OS source code. The procedure, assuming to start
          in the root of the project, is the following:</span></p>
      <ul>
        <li><span style="font-family: Verdana;">navigate to tapsetup folder: <code>cd
              RIOT-OS/dist/tools/tapsetup</code></span></li>
        <li><span style="font-family: Verdana;">configure an arbitrary number of
            interfaces (suppose 2) for the RIOT stations we'll be running: <code>./tapsetup
              -c 2</code></span></li>
        <li><span style="font-family: Verdana;"> assign an IPv6 address to the <em>tapbr0
              </em>interface: <code><span>sudo<span class="hljs-built_in"> ip </span>a
                a fec0:affe::1/64 dev tapbr0</span></code></span></li>
      </ul>
      <h4><span style="font-family: Verdana;">Running the MQTT-SN to MQTT bridge</span></h4>
      <p><span style="font-family: Verdana;">This component is located in the <code>mqttsn_mqtt_bridge
            </code>folder of the project. To run it, once entering with a
          terminal in the said folder, it is sufficient to use the <code>python
            bridge_aws.py. </code>The picture below shows both the broker and
          the MQTT-SN to MQTT bridge initialized and waiting to receive messages
          from the RIOT stations.<br>
        </span></p>
      <div style="text-align: center;"><span style="font-family: Verdana;"><img

            src="web_images/mqttsn_bridge_broker_running.jpg" alt="" title="bridge_broker_running"></span></div>
      <ul>
      </ul>
      <h4><span style="font-family: Verdana;">Building and running the RIOT-OS
          application</span></h4>
      <p><span style="font-family: Verdana;">The RIOT-OS application at the core
          of this project is located in the <code>riot_station_mqttsn</code>
          folder. To build run the application, we need first to enter the
          folder with a terminal and then use the <code>make all term PORT=tapX
            EMCUTE_ID=id</code> where X is the number of the <em>tap </em>interface
          to be assigned to the RIOT-OS instance (remember that these ports are
          numbered from 0 to <em>n-1</em> and a port can be assigned only to a
          single instance) and <em>id</em> is a unique name given to the
          instance (if the parameter is not specified, it will default to <em>gertrud</em>).</span></p>
      <p><span style="font-family: Verdana;">Suppose we are launching Station-01
          connected with port <em>tap0</em>: <code>make all term PORT=tap0
            EMCUTE_ID=Station-01</code></span></p>
      <p><span style="font-family: Verdana;">If the build is successful, the
          terminal will show the RIOT-OS prompt:</span></p>
      <div style="text-align: center;"><img src="web_images/riot_os_started.jpg"

          alt="" title="riot_os_prompt"></div>
      <div style="text-align: center;"><br>
      </div>
      <div style="text-align: left;"><span style="font-family: Verdana;">At this
          prompt, typing the <em>help</em> command causes the visualization of
          the available (implemented) RIOT-OS system commands:</span></div>
      <div style="text-align: left;"><span style="font-family: Verdana;"><br>
        </span></div>
      <div style="text-align: center;"><img src="web_images/riot_help.jpg"

          alt="" title="riot_help"></div>
      <div style="text-align: left;"><span style="font-family: Verdana;"><br>
        </span></div>
      <div style="text-align: left;"><span style="font-family: Verdana;">In the
          following steps we'll be using the <em>ifconfig </em>command to set
          up the network interface of the instance and the <em>init_start </em>command
          to begin the value generation and MQTT message transmission.</span></div>
      <div style="text-align: left;">
        <h5><span style="font-family: Verdana;">Setting up the network
            interfaces of the instance</span></h5>
        <p><span style="font-family: Verdana;">Before starting the
            transmissions, the network interface of the instance, connected to
            the chosen <em>tapX </em>interface has to be configured. To do so,
            in the RIOT prompt, use the <code>ifconfig 5 add fec0:affe::99 </code>command
            to set the interface address to<span style="font-family: monospace;">
            </span></span><span style="font-family: Verdana;"><code>fec0:affe::99.
              </code>Note that each RIOT-OS instance should be assigned its own
            <em>tap </em>interface, <em>EMCUTE_ID </em>value and IPv6
            address.</span></p>
        <h5><span style="font-family: Verdana;">Starting values generation and
            message transmission</span></h5>
        <p><span style="font-family: Verdana;">Once the network interface has
            been configured, it is possible to start the node activity by typing
            the <code>init_start</code></span><code><span style="color:#067d17;">
              &lt;station_id&gt; &lt;broker_address&gt; &lt;broker_port&gt;</span></code><span>,
            <span style="font-family: Verdana;">where <em>station_id </em>is a
              textual identifier for the station, transmitted along with MQTT
              messages (eventually can be the same as EMCUTE_ID),<em> </em>while
              <em>broker_address</em> and <em>broker_port </em>are the MQTT-SN
              broker address and port (in our case they are respectively </span></span><span

            style="font-family: Verdana;"><code><span>fec0:affe::1 </span></code><span>and
              <code>1885</code>. For example we can start node activity by
              typing </span></span><span style="font-family: Verdana;"><code>init_start
              RIOT-01</code></span><span style="font-family: Verdana;"><code><span>
                fec0:affe::1 1885.</span></code></span></p>
        <p><span style="font-family: Verdana;"><span>The following images show,
              in order, the RIOT station successfully transmitting, the MQTT-SN
              broker receiving messages and the bridge forwarding them to AWS
              IoT. <br>
            </span></span></p>
        <div style="text-align: center;"><img src="web_images/riot_os_transmitting.jpg"

            alt="" title="riot_os_transmitting"></div>
        <div style="text-align: center;"><br>
        </div>
        <div style="text-align: center;"><img src="web_images/mqttsn_bridge_broker_running2.jpg"

            alt="" title="bridge_broker_receiving"></div>
        <div style="text-align: center;"><br>
        </div>
        <div style="text-align: left;"><span style="font-family: Verdana;">At
            this point, if the dashboard web server and backend are running, it
            should be possible to see the values generated by the RIOT-OS
            virtual station.</span></div>
        <div style="text-align: left;">
          <h5><span style="font-family: Verdana;">Launching other virtual
              stations</span></h5>
          <p><span style="font-family: Verdana;">To launch other virtual
              stations, it is sufficient to repeat what's in the</span><span style="font-family: Verdana;">
              <em>Building and running the RIOT-OS application</em> paragraph
              until the desired number of stations is launched, keeping in mind
              that each station has to have its own <em>tap </em>interface, <em>EMCUTE_ID
                </em>and <em>IPv6 </em>address.</span></p>
        </div>
      </div>
    </div>
    <span style="font-family: Verdana;"> </span><span style="font-family: Verdana;">
    </span>
  </body>
</html>
