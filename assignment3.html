<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>IoT 2019/2020 Exam Assignment 3 Tutorial</title>
  </head>
  <body>
    <h1><span style="font-family: Verdana;">Assignment 3</span></h1>
    <h1><span style="font-family: Verdana;"> </span> <span style="font-family: Verdana;">
      </span> </h1>
    <h2><span style="font-family: Verdana;">RIOT-OS Virtual Environmental
        Stations running on FIT/IoTLab nodes publishing values to AWS IoT using
        LoRaWAN and TheThingsNetwork<br>
      </span></h2>
    <span style="font-family: Verdana;"> </span>
    <hr><span style="font-family: Verdana;"></span>
    <p><span style="font-family: Verdana;">This assignment is another extension
        of the projects for Assignment 1 and 2, where the same dashboard and
        backend components are used to collect and display data from a set of
        virtual environmental stations that are built over <i>RIOT-OS</i>, are
        deployed on the <i>FIT/IoT Lab</i> testbed and transmit the generated
        values to AWS IoT using <i>LoRaWAN</i> by <i>TheThingsNetwork</i> and
        MQTT.</span></p>
    <p><span style="font-family: Verdana;">The architecture implemented in this
        project can be represented as follows:</span></p>
    <div style="text-align: center;"><span style="font-family: Verdana;"><img src="web_images/assignment_3_architecture.png"
          alt="" title="assignment_3_architecture.png"></span></div>
    <div style="text-align: left;"><span style="font-family: Verdana;">More in
        detail, a set of <i>virtual environmental stations</i>, implemented as
        RIOT-OS applications and run on FIT/IoTLab St-Lrwan1 (Sx1276) nodes,
        generate random values for <i>temperature<em>, humidity, wind
            direction, wind intensity </em></i>and <i>rain height <em></em></i>and<i><em></em>
        </i>publishes them to a device on TheThingsNetwork using LoRaWAN. A
        TTN-MQTT to MQTT bridge, implemented in Python, subscribes using MQTT to
        the TheThingsNetwork MQTT broker and forwards the messages produced by
        the environmental stations to AWS IoT. The messages are then forwarded
        to the <i>dashboard backend</i>, implemented in Python, which
        subscribes to the topic on which the bridge publishes the values
        generated by the stations. Upon receiving the messages, which are in
        JSON format, the backend stores them to a text file, which is then used
        by the web server to populate the dashboard.</span></div>
    <div style="text-align: left;"><span style="font-family: Verdana;"><br>
        The dashboard and its backend are the same used in the <a href="assignment1.html">Assignment
          1 project</a>, and as a prerequisite we need the dashboard and the
        backend to be running, as well as the AWS configuration to be completed.
        For information on these aspects please refer to the Assignment 1
        project page. <br>
      </span>
      <h2><span style="font-family: Verdana;">Running the system</span></h2>
      <p><span style="font-family: Verdana;">In this tutorial we concentrate on
          running the RIOT-OS nodes and the MQTT-SN to MQTT bridge, supposing
          that the AWS configuration as described in the <a href="assignment1.html">Assignment
            1 project</a> page has been completed and the backend and web server
          for the dashboard are already running.</span></p>
      <h3><span style="font-family: Verdana;">Creating a device on
          TheThingsNetwork</span></h3>
      <p><span style="font-family: Verdana;">In order for this experiment to
          work, first of all you need to register to <a href="https://www.thethingsnetwork.org/">TheThingsNetwork</a>
          and access the Console. From within the console, you have to first of
          all create an <em>application</em> and then <em>a device</em> within
          such application. The device will be targeted the entry point for the
          messages published from the stations on TheThingsNetwork. Once the
          device is created, accessing the details should return the following
          information:</span></p>
      <div style="text-align: center;"><span style="font-family: Verdana;"><img
            src="web_images/TTN_device.png" alt=""></span></div>
      <p><span style="font-family: Verdana;">From this screen, take note of the
          <em>Device EUI</em>, <em>Application EUI </em>and <em>App Key </em>values,
          that will be necessary later to connect the RIOT-OS nodes to the TTN
          device. <br>
        </span></p>
      <h4><span style="font-family: Verdana;">Running the TTN to MQTT bridge</span></h4>
      <p><span style="font-family: Verdana;">This component is located in the <code>ttn_mqtt_bridge
            </code>folder of the project. Before running the bridge, you should
          put the connection information in the <code>ttn_bridge_conf.py </code>file.
          The information needed for the connection is the value for the <code>TTN_USERNAME_APP_ID
            </code>and <code>TTN_PW_ACCESS_KEY, </code>that can be retrieved
          from the <em>Application </em>page on the TTN console, in the
          Application Overview - Application ID and Access Keys sections.</span></p>
      <div style="text-align: center;"><span style="font-family: Verdana;"><img
            src="web_images/ttn_app_info.png" alt=""></span></div>
      <p><span style="font-family: Verdana;">Once the configuration is
          completed, the bridge is ready to run. Once entering with a terminal
          in the <code>ttn_mqtt_bridge</code> folder, it is sufficient to use
          the <code>python bridge_aws.py. </code>The picture below shows both
          the bridge initialized and waiting to receive messages from the RIOT
          stations.</span></p>
      <div style="text-align: center;"><span style="font-family: Verdana;"><img
            src="web_images/ttn_mqtt_broker_running.png" alt=""></span></div>
      <div style="text-align: center;"><span style="font-family: Verdana;"><br>
        </span></div>
      <div style="text-align: left;">
        <h4><span style="font-family: Verdana;">Running the RIOT-OS application
            on FIT/IoTLab nodes</span></h4>
        <p><span style="font-family: Verdana;">In order for this to be possible,
            you need first of all to register to the <a href="https://www.iot-lab.info/">FIT/IoTLab
              testbed</a>. Once this is done, it is possible to access the
            testbed and create a new experiment.</span></p>
        <h5><span style="font-family: Verdana;">Creating an experiment</span></h5>
        <p><span style="font-family: Verdana;">Upon creating a new experiment,
            the first information required are a <em>name</em> for the
            experiment, its duration and the start time.</span></p>
        <div style="text-align: center;"><span style="font-family: Verdana;"><img
              src="web_images/fit-iot-schedule.png" alt=""></span></div>
      </div>
      <div style="text-align: left;"><span style="font-family: Verdana;">Once
          this information is specified, then it is possible to create the
          arbitrary number of nodes we may want to run. At this point, it is
          important to choose the right architecture, otherwise there won't be
          LoRaWAN support and our application won't run correctly.</span></div>
      <div style="text-align: center;"><span style="font-family: Verdana;"><img
            src="web_images/fit-iot-nodes.png" alt=""></span></div>
      <div style="text-align: left;"><span style="font-family: Verdana;">Since
          this is only an example, let's consider a single node. Once the single
          node is added to the experiment, then we need to upload a firmware for
          it and select it using the <em>Add firmware </em>button.</span></div>
      <span style="font-family: Verdana;"><img src="web_images/fit-iot-node-firmware.png"
          alt=""></span></div>
    <div style="text-align: left;"><span style="font-family: Verdana;">The
        firmware can be built from scratch, by cloning the RIOT-OS repository
        similarly to what is done in <a href="assignment2.html">Assignment 2
          project</a>, or use the pre-built firmware in the<span style="color: #24292e;">
          <code>riot_station_ttn/bin/b-l072z-lrwan1/riot_station_ttn.elf</code></span><code><span
            style="color: #24292e;"></span></code><code><em style="box-sizing: border-box; color: #24292e; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: white; text-decoration-style: initial; text-decoration-color: initial;">.
          </em><span style="box-sizing: border-box; color: #24292e; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: white; text-decoration-style: initial; text-decoration-color: initial;"><br>
          </span></code></span></div>
    <div style="text-align: left;"><span style="font-family: Verdana;"><span style="box-sizing: border-box; color: #24292e; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: white; text-decoration-style: initial; text-decoration-color: initial;">Once
          the firmware is uploaded and selected, the experiment can be started.</span></span></div>
    <div style="text-align: left;"><span style="font-family: Verdana;"><span style="box-sizing: border-box; color: #24292e; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: white; text-decoration-style: initial; text-decoration-color: initial;"></span><br>
      </span>
      <h5><span style="font-family: Verdana;">Configuring each node and starting
          transmissions</span></h5>
      <p><span style="font-family: Verdana;">When the experiment state is <em>Running</em>,
          all the nodes have booted and are ready to be configured. <br>
        </span></p>
      <div style="text-align: center;"><img src="web_images/fit-iot-experiment.png"
          alt=""></div>
      <div style="text-align: justify;"><span style="font-family: Verdana;">To
          configure each node, we need to access its terminal from the <em>Actions
            </em>section. Upon starting, the terminal shows the usual RIOT-OS
          prompt and typing the <code>help </code>command shows the list of
          the available commands.<br>
        </span></div>
      <div style="text-align: center;"><img src="web_images/fit-iot-node-terminal.png"
          alt=""></div>
      <div style="text-align: justify;"><span style="font-family: Verdana;">To
          configure the LoRaWAN connection with the TheThingsNetwork device, we
          have to use the <code>loramac </code>command. The sequence of
          commands is the following:</span></div>
      <div style="text-align: justify;">
        <ul>
          <li><span style="font-family: Verdana;">Set the TTN Device EUI: <code>loramac
                set deveui &lt;deviceEui&gt;</code><br>
            </span></li>
          <li><span style="font-family: Verdana;">Set the TTN Application EUI: <code>loramac
                set appeui &lt;applicationEui&gt;</code></span></li>
          <li><span style="font-family: Verdana;">Set the TTN App Key: <code>loramac
                set appkey &lt;appKey&gt;</code><br>
            </span></li>
          <li><span style="font-family: Verdana;">Set the link data rate: <code>loramac
                set dr 5</code><br>
            </span></li>
          <li><span style=" font-family: Verdana;">Connect to the network using
              Over-The-Air-Activation: <code>loramac join otaa</code></span></li>
        </ul>
        <p><span style="font-family: Verdana;">Once the <code>loramac join otaa
            </code>returns successfully without failures, it is possible to
            start the values generation and transmission by using the <code>init_start
              &lt;station_id&gt;</code> command, where <code>&lt;station_id&gt;</code>
            is an identifier of the station transmitted along with the values.
            Upon starting the activity, if the bridge, the dashboard web server
            and dashboard backend are running, the generated values should be
            accessible on the dashboard. <br>
          </span></p>
        <ul>
        </ul>
      </div>
    </div>
    <div style="text-align: left;"><br>
    </div>
  </body>
</html>
